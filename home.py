import streamlit as st
import pandas as pd
import re
from thefuzz import process, fuzz
import io
from supabase import create_client, Client

# --- –ï—Ç–∞–ª–æ–Ω–Ω—ñ —Å–ø–∏—Å–∫–∏ —Ç–∞ —Å–ª–æ–≤–Ω–∏–∫–∏ ---

# –°–ª–æ–≤–Ω–∏–∫ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ª—ñ–Ω—ñ—ó –ø—Ä–µ–ø–∞—Ä–∞—Ç—É
PRODUCTS_DICT = {
    "–ê–¥–µ–Ω–æ—Ñ—ñ—Ç-—Ñ–æ—Ä—Ç–µ ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–ê–Ω–∫—Å—ñ–æ–º–µ–¥—ñ–Ω ‚Ññ20": "–õ—ñ–Ω—ñ—è 1",
    "–ê–Ω–∫—Å—ñ–æ–º–µ–¥—ñ–Ω ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–ê—Å—Ç–∞–¥—ñ–Ω–æ–ª 2000 ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–ê—Å—Ç–∞–¥—ñ–Ω–æ–ª 4000 ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–ê—Ç–µ—Ä–æ–¥—ñ–Ω–æ–ª ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–í—ñ–∑—ñ–Ω–æ—Ä–º ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–í—ñ–∑—ñ–Ω–æ—Ä–º ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–ì–ª—é—Ü–µ–º–µ–¥—ñ–Ω ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–ì–ª—é—Ü–µ–º–µ–¥—ñ–Ω ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–î–µ–ø—Ä—ñ–ª—ñ—É–º ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–î—É–æ–Ω–µ—Ñ—Ä–∏–ª ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–î—É–æ–Ω–µ—Ñ—Ä–∏–ª ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–î—É–æ–Ω–µ—Ñ—Ä–∏–ª ‚Ññ90": "–õ—ñ–Ω—ñ—è 1",
    "–î—É–æ–Ω–µ—Ñ—Ä–∏–ª-500 ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–î—É–æ–Ω–µ—Ñ—Ä–∏–ª-500 ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–î—É–æ–Ω–µ—Ñ—Ä–∏–ª-500 ‚Ññ90": "–õ—ñ–Ω—ñ—è 1",
    "–ó–æ–±–æ—Ñ—ñ—Ç ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–ó–æ–±–æ—Ñ—ñ—Ç –î–£–û ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–ó–æ–±–æ—Ñ—ñ—Ç –î–£–û ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–ó–æ–±–æ—Ñ—ñ—Ç –°–µ–ª–µ–Ω ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–Ü–º—É–Ω—Å–∏–ª D3 ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–º—É–Ω—Å–∏–ª D3 ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–º—É–Ω—Å–∏–ª D3 –î–£–û ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–º—É–Ω—Å–∏–ª D3 –î–£–û ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω–¥–æ–º—ñ—Ä–æ–ª ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω–¥–æ–º—ñ—Ä–æ–ª ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω–¥–æ–º—ñ—Ä–æ–ª-–ú ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω–¥–æ–º—ñ—Ä–æ–ª-–ú ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω–¥–æ–º—ñ—Ä–æ–ª-—Ñ–æ—Ä—Ç–µ ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω–¥–æ–º—ñ—Ä–æ–ª-–ú —Ñ–æ—Ä—Ç–µ ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–Ü–Ω—É–ª—ñ–Ω-–ù—É—Ç—Ä—ñ–º–µ–¥ ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–ö–∞–º–∞–≤—ñ—Ç-—Ñ–æ—Ä—Ç–µ ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–õ—ñ–≤–æ–¥—ñ–Ω–æ–ª ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–õ—ñ–≤–æ–¥—ñ–Ω–æ–ª –ú–∞–∫—Å ‚Ññ40": "–õ—ñ–Ω—ñ—è 2",
    "–ú–µ–Ω–æ–º–µ–¥—ñ–Ω ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–ú–µ–Ω–æ–º–µ–¥—ñ–Ω-–ú ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–ú–æ–Ω–º–æ—Ä–æ–ª ‚Ññ30": "–õ—ñ–Ω—ñ—è 1",
    "–ú–æ–Ω–º–æ—Ä–æ–ª ‚Ññ60": "–õ—ñ–Ω—ñ—è 1",
    "–ù–µ–æ–ø—Ä–æ—Å—Ç-—Ñ–æ—Ä—Ç–µ ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–ù–µ–æ–ø—Ä–æ—Å—Ç-—Ñ–æ—Ä—Ç–µ ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–û–≤–∞—Ä—ñ–º–µ–¥—ñ–Ω ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–†–µ—Å–≤–µ—Ä–∞–∑–∏–Ω ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–†–µ—Å–≤–µ—Ä–∞–∑–∏–Ω ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–°–æ–Ω–æ–º–µ–¥—ñ–Ω ‚Ññ20": "–õ—ñ–Ω—ñ—è 1",
    "–¶–µ—Ä–µ–±—Ä–æ–≤—ñ—Ç–∞–ª ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–¶–µ—Ä–µ–±—Ä–æ–≤—ñ—Ç–∞–ª ‚Ññ60": "–õ—ñ–Ω—ñ—è 2",
    "–¶–µ—Ä–µ–±—Ä–æ–≤—ñ—Ç–∞–ª –ê–∫—Ç–∏–≤ ‚Ññ30": "–õ—ñ–Ω—ñ—è 2",
    "–¶–∏–Ω–∫–æ—Ñ–µ—Ä–æ–ª-4000 ‚Ññ30": "–õ—ñ–Ω—ñ—è 1"
}

CANONICAL_CITIES = [
    "–ë–µ—Ä–µ–∂–∞–Ω–∏", "–ë–æ—Ä—â—ñ–≤", "–ë—É—á–∞—á", "–í–µ–ª–∏–∫–∞ –ë–µ—Ä–µ–∑–æ–≤–∏—Ü—è", "–í–µ–ª–∏–∫—ñ –î–µ–¥–µ—Ä–∫–∞–ª–∏",
    "–í–∏—à–Ω—ñ–≤–µ—Ü—å", "–ì–æ—Ä–æ–¥–Ω–∏—Ü—è", "–ì—Ä–∏–º–∞–π–ª—ñ–≤", "–ì—É—Å—è—Ç–∏–Ω", "–î—Ä—É–∂–±–∞", "–ó–∞–ª—ñ—â–∏–∫–∏",
    "–ó–±–∞—Ä–∞–∂", "–ó–æ–ª–æ—Ç–∏–π –ü–æ—Ç—ñ–∫", "–Ü–≤–∞–Ω–µ-–ü—É—Å—Ç–µ", "–ö–ª—é–≤–∏–Ω—Ü—ñ", "–ö–æ–∑–æ–≤–∞", "–ö–æ–ø–∏—á–∏–Ω—Ü—ñ",
    "–ö–æ—Ä–æ–ø–µ—Ü—å", "–ö—Ä–µ–º–µ–Ω–µ—Ü—å", "–õ–∞–Ω—ñ–≤—Ü—ñ", "–ú–µ–ª—å–Ω–∏—Ü—è-–ü–æ–¥—ñ–ª—å—Å—å–∫–∞", "–ú–∏–∫—É–ª–∏–Ω—Ü—ñ",
    "–ú–∏—à–∫–æ–≤–∏—á—ñ", "–ú–æ–Ω–∞—Å—Ç–∏—Ä–∏—Å—å–∫–∞", "–ù–∞–≥—ñ—Ä—è–Ω–∫–∞", "–û–∑–µ—Ä–Ω–∞", "–ü—ñ–¥–≥–∞–π—Ü—ñ",
    "–ü—ñ–¥–≤–æ–ª–æ—á–∏—Å—å–∫", "–ü–æ—á–∞—ó–≤", "–°–∫–∞–ª–∞-–ü–æ–¥—ñ–ª—å—Å—å–∫–∞", "–°–∫–∞–ª–∞—Ç", "–°—Ç—Ä—É—Å—ñ–≤",
    "–¢–µ—Ä–µ–±–æ–≤–ª—è", "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å", "–¢–æ–≤—Å—Ç–µ", "–•–æ—Ä–æ—Å—Ç–∫—ñ–≤", "–ß–æ—Ä—Ç–∫—ñ–≤", "–®—É–º—Å—å–∫"
]

STREET_TYPE_MAP = {
    "–ø—Ä–æ—Å–ø–µ–∫—Ç": "–ø—Ä–æ—Å–ø.", "–ø—Ä–æ—Å–ø.": "–ø—Ä–æ—Å–ø.", "–ø—Ä-—Ç": "–ø—Ä–æ—Å–ø.",
    "–≤—É–ª–∏—Ü—è": "–≤—É–ª.", "–≤—É–ª.": "–≤—É–ª.",
    "–±—É–ª—å–≤–∞—Ä": "–±—É–ª.", "–±—É–ª-—Ä": "–±—É–ª.", "–±-—Ä": "–±—É–ª.",
    "–ø–ª–æ—â–∞": "–ø–ª.", "–ø–ª.": "–ø–ª.",
    "–º–∞–π–¥–∞–Ω": "–º-–Ω.", "–º-–Ω": "–º-–Ω."
}

CANONICAL_STREET_NAMES = [
    "15-–≥–æ –ö–≤—ñ—Ç–Ω—è", "–ê–Ω—Ç–æ–Ω–∞ –ú–∞–Ω–∞—Å—Ç–∏—Ä—Å—å–∫–æ–≥–æ", "–ë–µ—Ä–µ–∂–∞–Ω—Å—å–∫–∞", "–ë–æ–≥–¥–∞–Ω–∞ –•–º–µ–ª—å–Ω–∏—Ü—å–∫–æ–≥–æ",
    "–ë–æ–≥–¥–∞–Ω–∞ –õ–µ–ø–∫–æ–≥–æ", "–ë—Ä–æ–¥—ñ–≤—Å—å–∫–∞", "–í. –°—Ç—É—Å–∞", "–í–∞—Å–∏–ª—è –°–∏–º–æ–Ω–µ–Ω–∫–∞", "–í–æ–∑–∑'—î–¥–Ω–∞–Ω–Ω—è",
    "–í–æ–ª–∏–Ω—Å—å–∫–∞", "–í–æ–ª–æ–¥–∏–º–∏—Ä–∞ –ì—Ä–æ–º–Ω–∏—Ü—å–∫–æ–≥–æ", "–í–æ–ª–æ–¥–∏–º–∏—Ä–∞ –õ—É—á–∞–∫–æ–≤—Å—å–∫–æ–≥–æ",
    "–í'—è—á–µ—Å–ª–∞–≤–∞ –ß–æ—Ä–Ω–æ–≤–æ–ª–∞", "–ì–∞–ª–∏—Ü—å–∫–∞", "–ì–µ–Ω–µ—Ä–∞–ª–∞ –ú–∏—Ä–æ–Ω–∞ –¢–∞—Ä–Ω–∞–≤—Å—å–∫–æ–≥–æ",
    "–ì–µ–Ω–µ—Ä–∞–ª–∞ –®—É—Ö–µ–≤–∏—á–∞", "–ì–µ—Ä–æ—ó–≤ –Ñ–≤—Ä–æ–º–∞–π–¥–∞–Ω—É", "–ì–µ—Ä–æ—ó–≤ –ö—Ä—É—Ç", "–ì–µ—Ç—å–º–∞–Ω–∞ –Ü–≤–∞–Ω–∞ –ú–∞–∑–µ–ø–∏",
    "–ì–æ—Ä–±–∞—á–∞", "–î–∞–Ω–∏–ª–∞ –ì–∞–ª–∏—Ü—å–∫–æ–≥–æ", "–î–º–∏—Ç—Ä–∞ –í–∏—à–Ω–µ–≤–µ—Ü—å–∫–æ–≥–æ", "–î–æ—Ä–æ—à–µ–Ω–∫–∞", "–î—Ä—É–∂–±–∏",
    "–î—É–±–µ–Ω—Å—å–∫–∞", "–ï–Ω–µ—Ä–≥–µ—Ç–∏—á–Ω–∞", "–ñ–∏–≤–æ–≤–∞", "–ó–∞–º–∫–æ–≤–∞", "–ó–±–∞—Ä–∞–∑—å–∫–∞", "–ó–ª—É–∫–∏",
    "–Ü–≤–∞–Ω–∞ –ú–∞–∑–µ–ø–∏", "–Ü–≤–∞–Ω–∞ –§—Ä–∞–Ω–∫–∞", "–ö–∞–≥–∞–Ω—Ü—è –ú–∞—Ä–∫–∞", "–ö–∞—Ä–ø–µ–Ω–∫–∞", "–ö–∏—ó–≤—Å—å–∫–∞",
    "–ö–ª—ñ–Ω—ñ—á–Ω–∞", "–ö–Ω—è–∑—è –í–∞—Å–∏–ª—å–∫–∞", "–ö–Ω—è–∑—è –í–æ–ª–æ–¥–∏–º–∏—Ä–∞", "–ö–æ–Ω–¥—Ä–∏", "–õ.–£–∫—Ä–∞—ó–Ω–∫–∏",
    "–õ–µ—Å—ñ –£–∫—Ä–∞—ó–Ω–∫–∏", "–õ–æ—Å—è—Ç–∏–Ω—Å—å–∫–∞", "–õ—å–æ—Ç—á–∏–∫—ñ–≤-–í–∏–∑–≤–æ–ª–∏—Ç–µ–ª—ñ–≤", "–ú–∞–∫–æ–≤–µ—è",
    "–ú–∏–∫–æ–ª–∏ –ö–∞—Ä–ø–µ–Ω–∫–∞", "–ú–∏–∫—É–ª–∏–Ω–µ—Ü—å–∫–∞", "–ú–∏—Ä—É", "–ú–∏—Ö–∞–π–ª–∞ –ì—Ä—É—à–µ–≤—Å—å–∫–æ–≥–æ",
    "–ú–∏—Ö–∞–π–ª–∞ –ü–∞—Ä–∞—â—É–∫–∞", "–ú—ñ—Ü–∫–µ–≤–∏—á–∞", "–ú—Å—Ç–∏—Å–ª–∞–≤–∞ –ü–∞—Ç—Ä—ñ–∞—Ä—Ö–∞", "–ú—Å—Ç–∏—Å–ª–∞–≤–∞",
    "–ù–∞–ª–∏–≤–∞–π–∫–∞", "–ù–µ–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ", "–ù–æ–≤–∞", "–ù–æ–≤–∏–π –°–≤—ñ—Ç", "–û–ª–µ—Å—è –ì–æ–Ω—á–∞—Ä–∞",
    "–û—Å–∏–ø–∞ –ú–∞–∫–æ–≤–µ—è", "–ü–∞–≤–ª–æ–≤–∞", "–ü–∞—Ç—Ä—ñ–∞—Ä—Ö–∞ –õ—é–±–æ–º–∏—Ä–∞ –ì—É–∑–∞—Ä–∞", "–ü–µ—Ä–µ–º–æ–≥–∏", "–ü–µ—Ä–ª—è",
    "–ü–µ—Ç—Ä–∞ –ì–µ—Ä–µ—Ç–∏", "–ü–µ—Ç—Ä–∞ –î–æ—Ä–æ—à–µ–Ω–∫–∞", "–ü–µ—Ç–ª—é—Ä–∏", "–ü–∏—Ä–æ–≥–æ–≤–∞", "–ü—ñ–¥–≥–∞—î—Ü—å–∫–∞",
    "–ü–æ–ª—ñ—Å—å–∫–∞", "–ü–æ—à—Ç–æ–≤–∞", "–†–∏–Ω–æ–∫", "–†–æ–º–∞–Ω–∞ –ì—Ä–∞–ª—é–∫–∞", "–†–æ–º–∞–Ω–∞ –ö—É–ø—á–∏–Ω—Å—å–∫–æ–≥–æ",
    "–†—É—Å—å–∫–∞", "–°–∞–≥–∞–π–¥–∞—á–Ω–æ–≥–æ", "–°–∞–¥–æ–≤–∞", "–°–∏–º–æ–Ω–∞ –ü–µ—Ç–ª—é—Ä–∏", "–°—ñ—á–æ–≤–∏—Ö –°—Ç—Ä—ñ–ª—å—Ü—ñ–≤",
    "–°—Ç–µ–ø–∞–Ω–∞ –ë–∞–Ω–¥–µ—Ä–∏", "–°—Ç–µ–ø–∞–Ω–∞ –ë—É–¥–Ω–æ–≥–æ", "–°—Ç–µ—Ñ–∞–Ω–∏–∫–∞", "–¢–∞—Ä–∞—Å–∞ –®–µ–≤—á–µ–Ω–∫–∞",
    "–¢–µ–∫—Å—Ç–∏–ª—å–Ω–∞", "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "–¢–æ—Ä–≥–æ–≤–∏—Ü—è", "–¢—Ä–æ–ª–µ–π–±—É—Å–Ω–∞", "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞",
    "–§–µ–¥—å–∫–æ–≤–∏—á–∞", "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞", "–®–∫—ñ–ª—å–Ω–∞", "–®–ø–∏—Ç–∞–ª—å–Ω–∞", "–Æ–ª—ñ–∞–Ω–∞ –û–ø—ñ–ª—å—Å—å–∫–æ–≥–æ"
]


# --- –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∞–¥—Ä–µ—Å ---

def parse_full_address(address: str) -> dict:
    """
    –ê–ª–≥–æ—Ä–∏—Ç–º—ñ—á–Ω–∏–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∞–¥—Ä–µ—Å, —è–∫–∏—Ö –Ω–µ–º–∞—î —É "–∑–æ–ª–æ—Ç–æ–º—É" —Å–ª–æ–≤–Ω–∏–∫—É.
    """
    result = {'city': None, 'street': None, 'number': None, 'territory': None}
    if not isinstance(address, str) or not address.strip():
        return result

    work_address = address.lower().strip()
    work_address = re.sub(r'\b\w+?—Å—å–∫–∞\s+–æ–±–ª\.?,?', '', work_address).strip(' ,')
    work_address = re.sub(r'[,\s]*\b(–ø—Ä–∏–º|–∫–≤|–∫–≤–∞—Ä—Ç–∏—Ä–∞|–ø–æ–º|–ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è|–∫–æ—Ä–ø—É—Å|–∫–æ—Ä–ø|–∫–Ω–ø|—Ç—Ä—Ü|—Ç–æ—Ä|–∫—Ü—Ä–ª)\b.*', '',
                          work_address)

    city_str, rest_of_address = None, work_address
    city_pattern = re.compile(r'^(–º|—Å–º—Ç|—Å–µ–ª–∏—â–µ|–º—ñ—Å—Ç–æ|—Å)\.?\s*([–∞-—è“ë“ë\'\-]+)')
    city_match = city_pattern.search(work_address)

    if city_match:
        city_candidate = city_match.group(2)
        best_match = process.extractOne(city_candidate, CANONICAL_CITIES, score_cutoff=85)
        if best_match:
            city_str = best_match[0]
            rest_of_address = work_address[city_match.end():].strip(' ,')
    else:
        best_match = process.extractOne(work_address, CANONICAL_CITIES, scorer=fuzz.WRatio, score_cutoff=88)
        if best_match and work_address.startswith(best_match[0].lower()):
            city_str = best_match[0]
            rest_of_address = work_address[len(city_str):].strip(' ,')

    result['city'] = city_str

    street_part = rest_of_address
    num_pattern = r'\b\d+[\w\-/]*\b'
    all_numbers = re.findall(num_pattern, rest_of_address)

    if all_numbers:
        number_str = all_numbers[-1]
        result['number'] = number_str
        number_match_pos = re.search(r'\b' + re.escape(number_str) + r'\b', rest_of_address)
        if number_match_pos:
            street_part = rest_of_address[:number_match_pos.start()].strip(' ,')

    street_type, street_name_candidate = "–≤—É–ª.", street_part
    sorted_street_types = sorted(STREET_TYPE_MAP.keys(), key=len, reverse=True)
    for key in sorted_street_types:
        pattern = r'^' + re.escape(key) + r'\b'
        if re.search(pattern, street_name_candidate):
            street_type = STREET_TYPE_MAP[key]
            street_name_candidate = re.sub(pattern, '', street_name_candidate).strip()
            break

    street_name_candidate = re.sub(r'\b–±—É–¥\.?\b', '', street_name_candidate)
    street_name_candidate = re.sub(r'\b[–∞-—è“ë“ë]\.\s*', '', street_name_candidate)
    street_name_candidate = street_name_candidate.strip(' ,-./')

    best_street_match = process.extractOne(street_name_candidate, CANONICAL_STREET_NAMES, score_cutoff=80)
    street_name = best_street_match[0] if best_street_match else street_name_candidate.title()

    if street_name:
        result['street'] = f"{street_type} {street_name}"

    return result


@st.cache_data(ttl=3600)  # –ö–µ—à—É—î–º–æ –¥–∞–Ω—ñ –Ω–∞ 1 –≥–æ–¥–∏–Ω—É
def load_golden_records_from_supabase() -> dict:
    """
    –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î "–∑–æ–ª–æ—Ç—ñ" –∑–∞–ø–∏—Å–∏ –∑ —Ç–∞–±–ª–∏—Ü—ñ Supabase —ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö —É —Å–ª–æ–≤–Ω–∏–∫.
    """
    try:
        url = "https://vimswywxzejgyvxjzuvf.supabase.co"
        key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpbXN3eXd4emVqZ3l2eGp6dXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NTk5NDYsImV4cCI6MjA2MTQzNTk0Nn0.bqcMzJaUet9yPsUEuXe6cqvKjzOBOBvQzBG6eXFl0VU"
        supabase: Client = create_client(url, key)

        table_name = "golden_addres"

        response = supabase.table(table_name).select("*").execute()

        data = response.data
        if not data:
            st.warning(f"–¢–∞–±–ª–∏—Ü—è '{table_name}' —É Supabase –ø–æ—Ä–æ–∂–Ω—è –∞–±–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞.")
            return {}

        golden_map = {}
        for row in data:
            key = str(row.get("–§–∞–∫—Ç.–∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏")).lower().strip()
            value = {
                'city': row.get("–ú—ñ—Å—Ç–æ"),
                'street': row.get("–í—É–ª–∏—Ü—è"),
                'number': str(row.get("–ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É")) if row.get("–ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É") is not None else None,
                'territory': row.get("–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è")
            }
            golden_map[key] = value

        st.success(f"–£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ {len(golden_map)} '–∑–æ–ª–æ—Ç–∏—Ö' –∑–∞–ø–∏—Å—ñ–≤ –∑ Supabase.")
        return golden_map

    except Exception as e:
        st.error(f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö –∑ Supabase: {e}")
        return {}


def process_address_hybrid(address: str, golden_map: dict) -> dict:
    """
    –ì—ñ–±—Ä–∏–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è: —Å–ø–æ—á–∞—Ç–∫—É —à—É–∫–∞—î —É —Å–ª–æ–≤–Ω–∏–∫—É, –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–∞—Ä—Å–µ—Ä.
    """
    lookup_key = str(address).lower().strip()
    golden_result = golden_map.get(lookup_key)

    if golden_result:
        return golden_result
    else:
        return parse_full_address(address)


# --- UI Streamlit ---

st.set_page_config(layout="wide")
st.title("üöÄ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —Ç–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü—ñ—ó –∞–¥—Ä–µ—Å")
st.write(
    "–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à Excel-—Ñ–∞–π–ª –∑ –∞–¥—Ä–µ—Å–∞–º–∏. –ï—Ç–∞–ª–æ–Ω–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö Supabase."
)

golden_map = load_golden_records_from_supabase()

uploaded_file = st.file_uploader(
    "–í–∏–±–µ—Ä—ñ—Ç—å Excel-—Ñ–∞–π–ª –∑ –∞–¥—Ä–µ—Å–∞–º–∏ –¥–ª—è –æ–±—Ä–æ–±–∫–∏",
    type=['xlsx', 'xls']
)

if uploaded_file is not None and golden_map:
    try:
        df = pd.read_excel(uploaded_file)

        required_columns = ['–†–µ–≥—ñ–æ–Ω', '–§–∞–∫—Ç.–∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏', '–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è']
        if not all(col in df.columns for col in required_columns):
            st.error(
                f"–ü–æ–º–∏–ª–∫–∞: –í –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ –≤—ñ–¥—Å—É—Ç–Ω—è –æ–¥–Ω–∞ –∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –∫–æ–ª–æ–Ω–æ–∫: {', '.join(required_columns)}."
            )
        else:
            st.info(f"–û—Å–Ω–æ–≤–Ω–∏–π —Ñ–∞–π–ª '{uploaded_file.name}' —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –í—Å—å–æ–≥–æ –∑–Ω–∞–π–¥–µ–Ω–æ {len(df)} —Ä—è–¥–∫—ñ–≤.")

            df_filtered = df[df['–†–µ–≥—ñ–æ–Ω'] == '24. –¢–µ—Ä–Ω–æ–ø—ñ–ª—å'].copy()

            if df_filtered.empty:
                st.warning("–£ —Ñ–∞–π–ª—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –∑ —Ä–µ–≥—ñ–æ–Ω–æ–º '24. –¢–µ—Ä–Ω–æ–ø—ñ–ª—å'. –ü–æ–¥–∞–ª—å—à–∞ –æ–±—Ä–æ–±–∫–∞ –Ω–µ–º–æ–∂–ª–∏–≤–∞.")
            else:
                st.info(
                    f"–ü—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∑–∞ —Ä–µ–≥—ñ–æ–Ω–æ–º '24. –¢–µ—Ä–Ω–æ–ø—ñ–ª—å' –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∑–∞–ª–∏—à–∏–ª–æ—Å—å **{len(df_filtered)}** —Ä—è–¥–∫—ñ–≤."
                )

                with st.spinner("‚ú® –û–±—Ä–æ–±–ª—è—î–º–æ –∞–¥—Ä–µ—Å–∏ —Ç–∞ –¥–æ–¥–∞—î–º–æ –¥–∞–Ω—ñ..."):
                    parsed_addresses = df_filtered['–§–∞–∫—Ç.–∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏'].apply(process_address_hybrid,
                                                                                 golden_map=golden_map)

                    parsed_df = pd.json_normalize(parsed_addresses)

                    # ‚≠êÔ∏è –û–ù–û–í–õ–ï–ù–û: –ü–µ—Ä–µ–π–º–µ–Ω–æ–≤—É—î–º–æ –Ω–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –Ω–∞–∑–≤–∏
                    parsed_df = parsed_df.rename(columns={
                        'city': 'City',
                        'street': 'Street',
                        'number': 'House_Number',
                        'territory': 'Territory'
                    })

                    df_filtered.reset_index(drop=True, inplace=True)
                    parsed_df.reset_index(drop=True, inplace=True)

                    # ‚≠êÔ∏è –û–ù–û–í–õ–ï–ù–û: –í–∏–¥–∞–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ —Å—Ç–∞—Ä—ñ –∫–æ–ª–æ–Ω–∫–∏, —è–∫—ñ –±—É–¥—É—Ç—å –∑–∞–º—ñ–Ω–µ–Ω—ñ
                    # –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ '–ú—ñ—Å—Ç–æ' –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–µ–¥–æ—Ç–æ—Ä–∫–∞–Ω–æ—é
                    df_filtered.drop(columns=['–í—É–ª–∏—Ü—è', '–ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É', '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è'], inplace=True, errors='ignore')

                    result_df = pd.concat([df_filtered, parsed_df], axis=1)

                    # ‚≠êÔ∏è –û–ù–û–í–õ–ï–ù–û: –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –∫–æ–ª–æ–Ω–∫—É –∑ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é –Ω–∞–∑–≤–æ—é
                    result_df['Product_Line'] = result_df['–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è'].str[3:].map(PRODUCTS_DICT)

                st.success("–ì–æ—Ç–æ–≤–æ! –ê–¥—Ä–µ—Å–∏ —É—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ.")
                st.dataframe(result_df)

    except Exception as e:
        st.error(f"–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ —Ñ–∞–π–ª—É: {e}")
